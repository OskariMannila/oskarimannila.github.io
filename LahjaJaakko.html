<!DOCTYPE HTML>
<!--
	Astral by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
	<head>
		<title>Oskari Mannila - Lahja-Jaakko</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
		<link rel="stylesheet" href="assets/css/main.css" />
		<link rel="stylesheet" href="assets/css/prism.css" />
		

		<noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>
	</head>
	<body class="is-preload">

		<!-- Wrapper-->
			<div id="wrapper">

				<!-- Nav -->
					<nav id="nav">
						
						<a href="index.html#portfolio" class="icon solid fa-folder"><span>Portfolio</span></a>
						<a href="index.html#contact" class="icon solid fa-envelope"><span>Yhteystiedot</span></a>
						
					</nav>

				<!-- Main -->
					<div id="main">
					
					<div class="panel"> 
								<header>
									<a href="LahjaJaakko.html" class="logo"><img src="images/LahjajaakkoLOGO.jpg" alt="Lahja-Jaakko" style="height: 200px; width: 200px;"></a>
									<h2>Lahja-Jaakko</h2>
								</header>
								<section>
									<table>
								  <tr>
									<th>Projektin tyyppi:</th>
									<th>JAMK / Demolab </th>
									
								  </tr>
								  <tr>
									<td>FrontEnd:</td>
									<td>Angular, Bootstrap</td>
								
								  </tr>
								    <tr>
									<td>BackEnd (BaaS):</td>
									<td>Firebase</td>
									
								  </tr>
								    <tr>
									<td>Tietokanta:</td>
									<td>Firebase firestore</td>
									
								  </tr>
								  </tr>
								    <tr>
									<td>Kielet:</td>
									<td>JavaScript, Typescript, CSS,  HTML5 </td>
									 <tr>
									<td>Ohjelmistot:</td>
									<td>VS Code, GIT Bash, NPM, PowerShell</td>
									
								  </tr>
									
								  </tr>
								  <tr>
									<td>Projektin kesto:</td>
									<td>4kk</td>
									
								  </tr>
								  <tr>
									<td>Tiimin koko:</td>
									<td>5</td>
									
								  </tr>
								 
								 
								</table>
									
									<p style="color: black;">Lahja-Jaakko on web-sovellus, jonka tarkoituksena on helpottaa lahjojen hankintaa. Toimin projektissa päätoimisena ohjelmoijana, mutta olin mukana myös suunnittelussa sekä testauksessa.</p>
									
									<p style="color: black;">Projektin alussa kokemukseni Angularin ja Firebasen käytöstä oli todella vähäistä. HTML ja CSS taas oli jo aika hyvin hallussa. Aluksi katselinkin paljon tutoriaaleja, joiden avulla opettelin perusteet.
									Firebasen opettelun ongelmaksi muodostui vähäinen materiaali. Kun perusteet alkoi olemaan hallussa, aloin toteuttamaan sovelluksen ominaisuuksia käyttäjäkertomusten perusteella. 
									Tein projektissa mm. kaikki CRUD-operaatiot, lomakkeet sekä todella paljon HTML5 koodia. CSS ja Bootstrap oli toisen tiimiläisen vastuulla, mutta niidenkään oppimiselta en kuitenkaan välttynyt.
									Suunnittelun puolella hommiani oli mm. hyväksymiskriteereiden kirjoittelu ja PO:lle ideoiden ehdottelu. 
									Testauksessa olin mukana alussa, johon tein mm. HTLP:tä sekä muutaman käyttäjäkertomuksen testisuunnitelmat ja testit.</p>
									
									<p style="color: black;">Projektista saatua osaamista esittelen sovelluksen suurimmilla haasteilla, jotka olivat google-kirjautuminen sekä käyttäjän poisto, näistä esimerkit ala-puolella.
															Näytän myös lahjalistan toteutusta, jossa näkyy hyvin HTML-osaamiseni.
									</p>
									
								
								
								</section>
								
								
								
<section style="text-align: left">

<h3> Google kirjautuminen: </h3>

<p> Kirjautumis-sivulla löytyy "Sign In With Google" -painike, jota painamalla aukeaa googlen-kirjautuminen omassa ikkunassa, Kun kirjautuminen google-tilille on tehty, sovellus siirtyy etusivulle.</p>
	    <div class="buttons d-flex justify-content-between">
	  	  <button href="#googleKirjautuminen"  class="btn btn-outline-dark btn-lg" data-slide="prev">
				<p class="buttontext">takaisin</p>
		</button>
		
   
	  	  <button href="#googleKirjautuminen"  class="btn btn-outline-dark btn-lg" data-slide="next">
				<p class="buttontext">seuraava</p>
			</button>
  
	  
	  </div>

	  
	  <div id="googleKirjautuminen" class="carousel slide" data-ride="carousel" data-interval="false" style="margin-bottom: 1%;">
	  
  <div class="carousel-inner">
    <div class="carousel-item active">
		<p>Kirjautumis-sivu ja "Sign In With Google" -painike.</p>
      <img class="d-block w-100" src="images/kirjautuminen.jpg" alt="First slide">
    </div>
    <div class="carousel-item">
	<p>Googlen kirjautuminen</p>
	 <img class="d-block w-100" src="images/googlePopUp.jpg" alt="Second slide">
    </div>
  
</div>

</div>
								
	<div id="accordion">

  <div class="card">
    <div class="card-header"  data-toggle="collapse" href="#collapseOne">
      <a class="card-link" data-toggle="collapse" href="#collapseOne">
        Google-kirjautumisen koodi
      </a>
    </div>
    <div id="collapseOne" class="collapse" data-parent="#accordion">
      <div class="card-body">
	  

	  <p>Firebase tarjosi google-kirjautumiseen valmiit metodit, mutta kirjautunut käyttäjä piti luoda myös tietokantaan. 
		Ongelmana oli kuitenkin, että google-kirjautuminen toimi samaan aikaan myös rekisteröitymisenä. Tämä ratkaistiin sillä, että kirjautuessa luodaan käyttäjä tietokantaan, jos sitä ei ole olemassa.</p>
	    <div class="buttons d-flex justify-content-between">
	  	  <button href="#googleKirjautuminenkoodi"  class="btn btn-outline-dark btn-lg" data-slide="prev">
				<p class="buttontext">takaisin</p>
		</button>
   
	  	  <button href="#googleKirjautuminenkoodi"  class="btn btn-outline-dark btn-lg" data-slide="next">
				<p class="buttontext">seuraava</p>
			</button>
  
	  
	  </div>

	  
	  <div id="googleKirjautuminenkoodi" class="carousel slide" data-ride="carousel" data-interval="false">
	  <ol class="carousel-indicators">
    <li data-target="#googleKirjautuminenkoodi" data-slide-to="0" class="active"></li>
    <li data-target="#googleKirjautuminenkoodi" data-slide-to="1"></li>
    <li data-target="#googleKirjautuminenkoodi" data-slide-to="2"></li>
	<li data-target="#googleKirjautuminenkoodi" data-slide-to="3"></li>
	<li data-target="#googleKirjautuminenkoodi" data-slide-to="4"></li>
  </ol>
	  
	  
  <div class="carousel-inner">
    <div class="carousel-item active">
	<p>Metodi, jota kutsutaan html:n puolella kokonaisuudessaan.</p>
	<p>kirjaudusisaan.component.ts:</p>
      <pre class="d-block w-100" alt="First slide"> <code class="language-javascript codebase"> tryGoogleLogin() {
    this.authService.doGoogleLogin()
      .then(res => {
        /* firebase.auth().onAuthStateChanged(),
        suorittaa useita kertoja, joka on sille ominaista, koska se suorittaa aina havaitessaan muutoksen.
        Koska haluamme sen ajavan vain kerran laitamme välimuuttujan authflag,
        jonka arvo laitetaan falseksi kun koodi on suorittanut kerran.  */
        let authflag = true;
        firebase.auth().onAuthStateChanged((user) => {
          //  Otetaan juuri kirjautuneen käyttäjän data talteen currentUser muuttujaan.
          if (authflag) {
          this.currentUser = { userID: user.uid, email: user.email, name: user.displayName, joinedGroups: [] };
          console.log(this.currentUser);
          authflag = false;
          }

        });

        // haetaan juuri kirjautuneen käyttäjän documentID tietokannasta ja tallennettaan se docID -muuttujaan.
        this.dataService.getDocumentID().then(
          (data) => { this.docID = data; },
          (err) => console.error(err)
        ).then(res => {
          // käytetään docID muuttujan arvoa etsimään onko firebasen tietokannassa dokumenttia, joka sisältää ko. id:n.
          this.dataService.checkIfUserExists(this.docID).then(docSnapshot => {
            if (docSnapshot.exists) {
              // jos dokumentti on olemassa, ei tehdä mitään.
              

            } else {
              // jos dokumenttia ei ole olemassa, luodaan käyttäjä.

              this.dataService.createUser(this.currentUser)
              .then(res => {
                /*do something here....
                maybe clear the form or give a success message*/
              });


            }
          }
          ).then(res => {
            // kun käyttäjä on kirjautunut, sovellus vie etusivulle.
            this.router.navigate(['/etusivu']);
          });
        });

      });
  }		 </code> </pre>
    </div>
    <div class="carousel-item">
	<p>Metodi, jolla haetaan kirjautuneen käyttäjän firebase dokumentin ID.</p>
	<p>data.service.ts:</p>
	<pre class="d-block w-100" alt="Second slide"> <code class="language-javascript codebase">  /*
  getDocumentID() on metodi, joka palauttaa kirjautuneen käyttäjän firebase dokumentin ID:n
  */
  getDocumentID() {

    return new Promise((resolve, reject) => {
      firebase.auth().onAuthStateChanged(user => {
        try {
          let userObs = this.firestore.collection('users', ref => ref.where('userID', '==', user.uid)).snapshotChanges();
          userObs.pipe(take(1)).subscribe(data => {
            // Yritetään lähettää resolveen dokumentin id, jos sitä ei löydy tulee error,
            // joka ratkaistaan lähettämällä jokin koodi, jota ei ole olemassa.
            try {
              resolve(data[0].payload.doc.id);
            } catch (err) {
              console.log('Käyttäjää ei löydy' + err);
              resolve('thisIsTheIDthatNeverWillExistsInDataBase!');
            }
          });
        } catch (err) { console.log('Kirjautunutta käyttäjää ei löydy, koska et ole kirjautunut: ' + err) };


      }, err => reject(err));
    });
  } </code> </pre>
    </div>
    <div class="carousel-item">
	<p>Metodi, jolla haetaan firebase dokumentti tietokannasta, sen ID:n perusteella.</p>
	<p>data.service.ts:</p>
	<pre class="d-block w-100" alt="Third slide"> <code class="language-javascript codebase">   /*
  checkIfUserExists(docID) on metodi jolla haetaan dokumentti tietokannasta firebase dokumentin ID:n perusteella.
  Metodi palauttaa dokumentin, jota voidaan tarkastella komponentin puolella, onko se olemassa vai ei.
  Käytetään mm. google-kirjautumisessa, ettei tietokantaa luoda ylimääräisiä käyttäjiä.
  */

  checkIfUserExists(docID) {

    return new Promise<any>((resolve, reject) => {
      resolve(this.firestore.firestore.doc('/users/' + docID).get());
    });

  }</code> </pre>
    </div>
	
	 <div class="carousel-item">
	 <p>Metodi, jolla luodaan käyttäjä tietokantaan.</p>
	 <p>data.service.ts:</p>
	<pre class="d-block w-100" alt="Fourth slide"> <code class="language-javascript codebase"> /*
    createUser(data) on metodi, jolla lisätään käyttäjän data tietokantaan.
  */

  createUser(data) {
    return new Promise<any>((resolve, reject) => {
      this.firestore
        .collection('users')
        .add(data)
        .then(res => { }, err => reject(err));
    });
  }</code> </pre>
    </div>
	
	 <div class="carousel-item">
	 <p> "Sign in with google" -Painike, jossa metodi suoritetaan.</p>
	 <p>kirjaudusisaan.component.html:</p>
	<pre class="d-block w-100" alt="Fourth slide"> <code class="language-html codebase"> 


	<&lt;div class="form-group row justify-content-center">
      <&lt;div class="col-auto col-md-auto col-sm-auto">
        <&lt;button class="google-btn" (click)="tryGoogleLogin()"><&lt;/button>
      <&lt;/div>
    <&lt;/div> 





	
    
  </code> </pre>
    </div>
  </div>
  
</div>
       
      </div>
    </div>
  </div>
  

  

</div>
								
									
									
</section>

<section style="text-align: left">

<h3> Käyttäjän poisto: </h3>

<p> Käyttäjän poisto löytyy sovelluksen profiili-sivulta. Käyttäjän poisto pitää sisällään käyttäjän poiston tietokannasta, 
	käyttäjän luomien ryhmien poiston, käyttäjän poiston ryhmistä joihin hän on liittynyt sekä itse firebase autentikaatio tunnuksen poiston.</p>
	    <div class="buttons d-flex justify-content-between">
	  	  <button href="#käyttäjänpoisto"  class="btn btn-outline-dark btn-lg" data-slide="prev">
				<p class="buttontext">takaisin</p>
		</button>
		
   
	  	  <button href="#käyttäjänpoisto"  class="btn btn-outline-dark btn-lg" data-slide="next">
				<p class="buttontext">seuraava</p>
			</button>
  
	  
	  </div>

	  
	  <div id="käyttäjänpoisto" class="carousel slide" data-ride="carousel" data-interval="false" style="margin-bottom: 1%;">
	  
  <div class="carousel-inner">
    <div class="carousel-item active">
		<p>Profiili-sivun muokkaustila ja "Poista tili" -painike.</p>
      <img class="d-block w-100" src="images/profiili.jpg" alt="First slide">
    </div>
    <div class="carousel-item">
	<p>Poiston varmistus</p>
	 <img class="d-block w-100" src="images/poistovarmistus.jpg" alt="Second slide">
    </div>
  
</div>

</div>
								
	<div id="accordion2">

  <div class="card">
    <div class="card-header"  data-toggle="collapse" href="#collapseTwo">
      <a class="card-link" data-toggle="collapse" href="#collapseTwo">
        Käyttäjän poiston koodi
      </a>
    </div>
    <div id="collapseTwo" class="collapse" data-parent="#accordion2">
      <div class="card-body">
	  

	  <p>Firebasen firestore tietokannan yksinkertaisuus osoittautui haastelliseksi näin isossa operaatiossa.</p>
	    <div class="buttons d-flex justify-content-between">
	  	  <button href="#käyttäjänPoistoKoodi"  class="btn btn-outline-dark btn-lg" data-slide="prev">
				<p class="buttontext">takaisin</p>
		</button>
   
	  	  <button href="#käyttäjänPoistoKoodi"  class="btn btn-outline-dark btn-lg" data-slide="next">
				<p class="buttontext">seuraava</p>
			</button>
  
	  
	  </div>

	  
	  <div id="käyttäjänPoistoKoodi" class="carousel slide" data-ride="carousel" data-interval="false">
	  <ol class="carousel-indicators">
    <li data-target="#käyttäjänPoistoKoodi" data-slide-to="0" class="active"></li>
    <li data-target="#käyttäjänPoistoKoodi" data-slide-to="1"></li>
    <li data-target="#käyttäjänPoistoKoodi" data-slide-to="2"></li>
	<li data-target="#käyttäjänPoistoKoodi" data-slide-to="3"></li>
	<li data-target="#käyttäjänPoistoKoodi" data-slide-to="4"></li>
	<li data-target="#käyttäjänPoistoKoodi" data-slide-to="5"></li>
  </ol>
	  
	  
  <div class="carousel-inner">
    <div class="carousel-item active">
	<p>Metodi, jota kutsutaan html:n puolella kokonaisuudessaan.</p>
	<p>profiili.component.ts:</p>
      <pre class="d-block w-100" alt="First slide"> <code class="language-javascript codebase">
    RemoveUser() {

	// Selaimen varmistus, palauttaa true/false.
    let removeConfirm = confirm('haluatko varmasti poistaa käyttäjätilisi?');

	// jos palautuu true.
    if (removeConfirm) {
	// Poistetaan käyttäjä ryhmistä, johon hän on liittynyt ja ryhmät jotka ovat hänen luomiaan.
    this.dataService.deleteUserFromGroups().then(res => {

      if (res) {
		// Haetaan käyttäjän firebase dokumentin ID.
        this.dataService.getDocumentID().then(documentID => {
		
			// poistetaan käyttäjä tietokannasta.
          this.dataService.deleteUserFromDatabase(documentID).then(done => {

            console.log(done);
            if (done) {
              // lopuksi poistetaan käyttäjän firebase tili sovelluksesta.
              const user = firebase.auth().currentUser;
              user.delete();
			  // navigoidaan kirjautumis-sivulle.
              this.router.navigate(['/kirjaudu']);
            }

          });
        });
      }

    });
  } }	 </code> </pre>
    </div>
    <div class="carousel-item">
	<p>Metodi, jolla poistetaan käyttäjän luomista ryhmistä liittyneet käyttäjät, itse ryhmä sekä käyttäjän muiden luomista ryhmistä.</p>
	<p>data.service.ts:</p>
	<pre class="d-block w-100" alt="Second slide"> <code class="language-javascript codebase">
	
	
	deleteUserFromGroups() {

    return new Promise<any>((resolve, reject) => {

      let currentUser;

      // Haetaan kirjautunut käyttäjä.
      this.getCurrentUserFromDatabase().then(user => {
        currentUser = user;
        // haetaan kirjautuneen käyttäjän joinedGroups, eli ryhmät johon käyttäjä on liittynyt
        this.getUsersGroupsById().then(data => {
          console.log(data);
          let ArrayOfGroups = data;

          if (ArrayOfGroups.length === 0) {
            resolve(true);
            console.log('tyhjä');
          }

          let iterations = ArrayOfGroups.length;
          // loopataan ryhmät läpi:
          for (let group of ArrayOfGroups) {
            // jos kirjautunut käyttäjä on ryhmän admin, poistetaan kaikki käyttäjät ryhmästä ja itse ryhmä.
            // jos ei ole, niin poistetaan pelkästään kirjautunut käyttäjä ryhmästä.
            console.log(group.groupAdmin, ' ', currentUser.userID);
            if (group.groupAdmin === currentUser.userID) {
              // poistetaan kirjautunut käyttäjä ryhmästä.
              this.deleteUserFromGroup(currentUser.userID, group.groupCode);

              if (group.joinedUsers.length === 0) {
                this.getGroupDocumentID(group.groupCode).then(docRef => {
                  this.deleteGroup(docRef);
                });
              }

              // käydään läpi kaikki ryhmään liittyneet ja poistetaan ne ryhmästä.
              let i;
              for (i = 0; i < group.joinedUsers.length; i++) {
                this.deleteUserFromGroup(group.joinedUsers[i], group.groupCode);
                // kun looppi on käyty läpi.
                if (i === group.joinedUsers.length - 1) {

                  // haetaan ryhmän firestore dokumentti id, jolla poistetaan koko ryhmä.
                  this.getGroupDocumentID(group.groupCode).then(docRef => {
                    this.deleteGroup(docRef);
                  });
                }
              }

              // jos kirjautunut käyttäjä ei ole ryhmän admin, poistetaan pelkästään hänet ryhmästä.
            } else { this.deleteUserFromGroup(currentUser.userID, group.groupCode); }

            // jos ArrayOfGroups on käyty läpi palauta true. kun iterations arvo on 0, ehto on true.
            if (!--iterations) {
              resolve(true);
            }
          }

        });
      });

    });

  }
	
	
	
	
	
	
	
	
	</code> </pre>
    </div>
	
	 <div class="carousel-item">
	<p>Metodi, jolla haetaan kaikki käyttäjän ryhmät.</p>
	<p>data.service.ts:</p>
	<pre class="d-block w-100" alt="Second slide"> <code class="language-javascript codebase">
	
	getUsersGroupsById() {
    let currentUser;
    let ArrayOfGroups = [];

    return new Promise<any>((resolve, reject) => {
      // haetaan kirjautuneen käyttäjän datatietokannasta.
      this.getCurrentUserFromDatabase().then(
        (data) => {
          // tallennetaan kirjautuneen käyttäjän data currentUser -muuttujaan.
          currentUser = data, console.log(data);

          if (currentUser.joinedGroups.length === 0) {
            // jos kirjautunut käyttäjä ei ole missään ryhmässä, niin palautetaan suoraan tyhjätaulukko.
            console.log(ArrayOfGroups);
            resolve(ArrayOfGroups);
          }
          const groups = currentUser.joinedGroups
            .map(groupCode => this.firestore.collection('groups', ref => ref.where('groupCode', '==', groupCode)).valueChanges());

          Promise.all(groups.map(async group => {
            const groupWaited = await group;
            groupWaited.pipe(take(1)).subscribe(data => {
              data.forEach(v => {
                ArrayOfGroups.push({ ...v });
              });
  
              // kun taulukko on käyty läpi, palautetaan se.
              if (ArrayOfGroups.length === groups.length) {
                resolve(ArrayOfGroups);
              }
            });
          }
          ));
          console.log(ArrayOfGroups);
        },
        (err) => console.error(err));
    });
  }
	
	
 
	
	
	
	
	
	
	
	
	</code> </pre>
    </div>
	
	<div class="carousel-item">
	<p>Metodi, jolla poistetaan käyttäjä ryhmästä.</p>
	<p>data.service.ts:</p>
	<pre class="d-block w-100" alt="Second slide"> <code class="language-javascript codebase">
	
	/* deleteUserFromGroup() on metodi, jolla poistetaan käyttäjä ryhmästä. 
	Metodissa poistetaan käyttäjän ID ryhmän joinedUsers -taulusta
   sekä ryhmän ID käyttäjän joinedGroups -taulusta */

  deleteUserFromGroup(userID, groupCode) {

    return new Promise<any>((resolve, reject) => {
      let group;
      let index;

      let DocRefID;
      let user;
      let indexOfUser;

      /*
      Ensin haetaan ryhmän data, jonka avulla poistetaan ryhmän joinedUsers -taulukosta käyttäjän userID. 
      */
      this.getGroupFromDatabase(groupCode).then(groupData => {
        group = groupData;
      }).then(() => {
        // haetaan taulukon indexi, userID:n avulla.
        index = group.joinedUsers.indexOf(userID);
        // indexOf palauttaa -1, jos taulukosta ei löydy indexiä sille syöttämälle parametrille.
        // joten jos index on suurempi kuin -1, poistetetaan yksi elementti indexin paikalta.
        if (index > -1) {
          group.joinedUsers.splice(index, 1);
          this.getGroupDocumentID(groupCode).then(res => {
            this.updateGroupsJoinedUsers(res, group.joinedUsers);
          });
        }

        // haetaan ensin käyttäjä sen UID:n perusteella. kun käyttäjän tiedot on haettu, päivitetään käyttäjän joinedGroups taulu.
        return new Promise<any>((resolve, reject) => {

          let userObs = this.firestore.collection('users', ref => ref.where('userID', '==', userID)).snapshotChanges();
          userObs.pipe(take(1)).subscribe(data => {
            DocRefID = data[0].payload.doc.id;
            user = data[0].payload.doc.data();
            resolve(true);
          });
        }).then(res => {

          // jos käyttäjän tiedot on haettu resposena tulee true.
          if (res) {

            // jos taulukosta löytyy indexi ryhmäkoodilla.
            indexOfUser = user.joinedGroups.indexOf(groupCode);

            if (indexOfUser > -1) {

            
              // poistetaan joinedGroups -taulukosta kentän arvo, jossa on ryhmäkoodi.
              this.checkIfUserExists(DocRefID).then(DocSnapshot => {

                if (DocSnapshot.exists) {
                  this.firestore
                    .collection('users')
                    .doc(
                      (DocRefID)).update({ joinedGroups: firebase.firestore.FieldValue.arrayRemove(groupCode) });


                }
              });
         
              resolve(true);
            }
          }

        });
      });
    });
  }
	
	
	
	
	
	</code> </pre>
    </div>
    <div class="carousel-item">
	<p>Ryhmän CRUD-metodit, joita käytetty käyttäjän poistossa:</p>
	<p>data.service.ts:</p>
	<pre class="d-block w-100" alt="Third slide"> <code class="language-javascript codebase"> 
	
	/* 
   getGroupFromDatabase(groupCode) on metodi, jolla haetaan ryhmän data tietokannasta ryhmäkoodin perusteella.
	*/
  getGroupFromDatabase(groupCode) {


    return new Promise((resolve, reject) => {
      //  firebase.auth().onAuthStateChanged(user => {
      let groupObs = this.firestore.collection('groups', ref => ref.where('groupCode', '==', groupCode)).snapshotChanges();
      groupObs.pipe(take(1)).subscribe(data => {

        if (data[0]) {
          resolve(data[0].payload.doc.data());
        }
      });
    });
  }
	
	
  // metodi, jolla asetetaan käyttäjän id, ryhmän joinedUsers taulukkoon.

  updateGroupsJoinedUsers(groupDocID, array) {

    return new Promise((resolve, reject) => {

      this.checkIfGroupExists(groupDocID).then(docSnapshot => {
        if (docSnapshot.exists) {

          this.firestore
            .collection('groups').doc(
              (groupDocID)).update({ joinedUsers: array });
          resolve(true);
        }
      });
	});
  }
	
	
  // metodi, jolla haettaan ryhmän firebase dokumentin ID, ryhmäkoodin perusteella.
  getGroupDocumentID(groupCode) {

    return new Promise((resolve, reject) => {

      let groupObs = this.firestore.collection('groups', ref => ref.where('groupCode', '==', groupCode)).snapshotChanges();
      groupObs.pipe(take(1)).subscribe(data => {
        // Yritetään lähettää resolveen dokumentin id, jos sitä ei löydy tulee error,
        // joka ratkaistaan lähettämällä jokin koodi, jota ei ole olemassa.
        try {
          resolve(data[0].payload.doc.id);
        } catch (err) {
          console.log('Ryhmää ei löydy ' + err);
          resolve('thisIsTheIDthatNeverWillExistsInDataBase!');
        }
      });
    });
  }
	
	
	
	
	</code> </pre>
    </div>
	
	 <div class="carousel-item">
	 <p>Käyttäjän CRUD-metodit, joita käytetty käyttäjän poistossa:</p>
	 <p>data.service.ts:</p>
	<pre class="d-block w-100" alt="Fourth slide"> <code class="language-javascript codebase">
	
	 /*
  getCurrentUserFromDatabase() on metodi, jolla haetaan kirjautuneen käyttäjän data tietokannasta UID:n perusteella.
  */
  getCurrentUserFromDatabase() {

    return new Promise((resolve, reject) => {
      firebase.auth().onAuthStateChanged(user => {
        if (user) {
          let userObs = this.firestore.collection('users', ref => ref.where('userID', '==', user.uid)).snapshotChanges();
          userObs.pipe(take(1)).subscribe(data => {

            if (data[0]) {
              resolve(data[0].payload.doc.data());
            }
          });

        }
      }, err => reject(err));
    });
  }

 /*
  getDocumentID() on metodi, joka palauttaa kirjautuneen käyttäjän firebase dokumentin ID:n
  */
  getDocumentID() {

    return new Promise((resolve, reject) => {
      firebase.auth().onAuthStateChanged(user => {
        try {
          let userObs = this.firestore.collection('users', ref => ref.where('userID', '==', user.uid)).snapshotChanges();
          userObs.pipe(take(1)).subscribe(data => {
            // Yritetään lähettää resolveen dokumentin id, jos sitä ei löydy tulee error,
            // joka ratkaistaan lähettämällä jokin koodi, jota ei ole olemassa.
            try {
              resolve(data[0].payload.doc.id);
            } catch (err) {
              resolve('thisIsTheIDthatNeverWillExistsInDataBase!');
            }
          });
        } catch (err) { console.log(err) };


      }, err => reject(err));
    });
  }
   
  </code> </pre>
    </div>
	
	 
	
  </div>
  
</div>
       
      </div>
    </div>
  </div>
  

  

</div>
								
									
									
</section>

<section style="text-align: left">

<h3> Lahjalista: </h3>

<p> Lahjalistasta haluan esitellä sen HTML puolta. 
	Lahjojen muokkaus, poistaminen ja lisääminen olivat lähinnä yksinkertaisia CRUD-metodeita.  </p>
	    <div class="buttons d-flex justify-content-between">
	  	  <button href="#lahjalista"  class="btn btn-outline-dark btn-lg" data-slide="prev">
				<p class="buttontext">takaisin</p>
		</button>
		
   
	  	  <button href="#lahjalista"  class="btn btn-outline-dark btn-lg" data-slide="next">
				<p class="buttontext">seuraava</p>
			</button>
  
	  
	  </div>

	  
	  <div id="lahjalista" class="carousel slide" data-ride="carousel" data-interval="false" style="margin-bottom: 1%;">
	  
  <div class="carousel-inner">
    <div class="carousel-item active">
		<p>Lahjalista, kun lahjat ovat kiinni (ylläpitäjä).</p>
      <img class="d-block w-100" src="images/lahjakiinni.jpg" alt="First slide">
    </div>
    <div class="carousel-item">
	<p>Lahjalista, kun lahjat ovat avattuna (ylläpitäjä).</p>
	 <img class="d-block w-100" src="images/lahjaauki.jpg" alt="Second slide">
    </div>
	 <div class="carousel-item">
	<p>Lahjalista, kun lahjat ovat avattuna (liittynyt käyttäjä).</p>
	 <img class="d-block w-100" src="images/liittynytkayttaja.jpg" alt="Third slide">
    </div>
  
</div>

</div>
								
	<div id="accordion3">

  <div class="card">
    <div class="card-header"  data-toggle="collapse" href="#collapseThree">
      <a class="card-link" data-toggle="collapse" href="#collapseThree">
       Lahjalistan koodi
      </a>
    </div>
    <div id="collapseThree" class="collapse" data-parent="#accordion3">
      <div class="card-body">
	  

	  <p>Lahjalista-sivu sisälsi ehkä sovelluksen haastavimman HTML-ratkaisun. Lahjat avautuvat collapsena sekä niitä pystyy muokkaamaan. 
	  Haasteiksi osoittautui aluksi lahjojen yksilöinti. </p>
	    <div class="buttons d-flex justify-content-between">
	  	  <button href="#LahjalistaKoodi"  class="btn btn-outline-dark btn-lg" data-slide="prev">
				<p class="buttontext">takaisin</p>
		</button>
   
	  	  <button href="#LahjalistaKoodi"  class="btn btn-outline-dark btn-lg" data-slide="next">
				<p class="buttontext">seuraava</p>
			</button>
  
	  
	  </div>

	  
	  <div id="LahjalistaKoodi" class="carousel slide" data-ride="carousel" data-interval="false">
	  <ol class="carousel-indicators">
    <li data-target="#LahjalistaKoodi" data-slide-to="0" class="active"></li>
    <li data-target="#LahjalistaKoodi" data-slide-to="1"></li>
	 <li data-target="#LahjalistaKoodi" data-slide-to="2"></li>
  </ol>
	  
	  
  <div class="carousel-inner">
    <div class="carousel-item active">
	<p>Lahjalistan lahjojen tulostus sekä collapse-näkymä.
		Collapsen eri näkymien (muokkaus/ylläpitäjä/varaaja) tekeminen vaati paljon pähkäilyä. 
	</p>
	<p>lahjalista.component.html:</p>
      <pre class="d-block w-100" alt="First slide"> <code class="language-javascript codebase">
	 
// Luodaan joka lahjasta oma divi, looppaamalla lahjalista läpi sekä tallennetaan rivin indeksi:
	  
&lt;div *ngFor="let gift of giftList; let RowIndex = index">
		 
	// Luodaan divin sisään listItem, jota klikkaamalla avataan lahjan collapse näkymä:
	&lt;li class="btn no-hover d-flex justify-content-between align-items-center" data-toggle="collapse"
	attr.data-target="#giftexpand{{RowIndex}}" (click)="editStatus && cancelEdit()">
		  
          &lt;p>{{gift.name}}&lt;/p>
          &lt;button *ngIf="gift.reserved" class="btn btn-red" [disabled]="true">varattu&lt;/button>
          &lt;p>{{gift.price}} € &lt;i class="fas fa-caret-down">&lt;/i>&lt;/p>

    &lt;/li>
		
		// Käytetään collapse divin id:ssä rivin indeksiä, jotta collapset ovat yksilöityjä.
        &lt;div class="collapse row justify-content-center" id="giftexpand{{RowIndex}}">
		// jos editStatus on false, lahjan "perus näkymää" ei näytetä.
          &lt;div class="info-col col-11 col-md-11 " *ngIf="!this.editStatus">
          &lt;a href="{{gift.link}}" target="_blank">{{ (gift.link.length>30)? (gift.link | slice:8:30)+'...':(gift.link | slice:8:30) }}
          &lt;/a>
         &lt;p>{{gift.price}}€&lt;/p>
         &lt;p>{{gift.description}}&lt;/p>


			// painikkeet, joista voi poistaa lahjan, varata lahjan, muokata lahjaa. painikkeiden näkyvyys myös muuttuu editStatuksen ja adminStatuksen mukaan.
          &lt;button *ngIf="!gift.reserved && !adminStatus"class="btn btn-red" style="float: right;" (click)="reserveGift(gift)">Varaa&lt;/button>
          &lt;button *ngIf="gift.reserved && gift.reserver !== currentUser.userID"class="btn btn-red" style="float: right;" [disabled]="true">Varattu&lt;/button>
          &lt;button *ngIf="gift.reserved && gift.reserver === currentUser.userID && !adminStatus" class="btn btn-red" style="float: right;" (click)="unreserveGift(gift)">Peru Varaus&lt;/button>
          &lt;button *ngIf="adminStatus && !gift.reserved"class="btn btn-blu" style="float: right;" (click)="editStatusChanger(gift)">Muokkaa&lt;/button>
          &lt;button *ngIf="adminStatus"class="btn btn-red" style="float: right;" (click)="deleteGift(gift)">Poista&lt/button>
		&lt/div>
		
		// kun lahjat sisältävät myös lahjan muokkauksen, joka näkyy, jos lahjan  editStatus on true.
        &ltdiv class="info-col col-11 col-md-11 " *ngIf="this.editStatus && this.SelectedGiftID === gift.documentID">
         
          &ltform [formGroup]="this.dataService.updateGiftForm">

            &ltlabel for="name">Lahjan nimi <span class="req-tah">*&lt/span>&lt/label>
            &ltinput formControlName="name" type="text" class="form-control" placeholder="Syötä lahjan nimi" required>
            &ltp *ngIf=" this.dataService.updateGiftForm.controls.name.invalid && this.dataService.updateGiftForm.controls.name.errors.maxlength"
              class="errorText row justify-content-center">
              Lahjan nimi saa olla maksimissaan 30 merkkiä pitkä.
            &lt/p>
            &ltp *ngIf=" this.dataService.updateGiftForm.controls.name.invalid && this.dataService.updateGiftForm.controls.name.errors.required 
            && this.dataService.updateGiftForm.controls.name.touched" class="errorText row justify-content-center">
              Lahjalla on oltava nimi.
            &lt/p>

            &ltlabel for="price">Lahjan hinta-arvio (€)&lt/label>
            &ltinput formControlName="price" type="text" class="form-control" placeholder="Syötä lahjan hinta-arvio">
            &ltp *ngIf=" this.dataService.updateGiftForm.controls.price.invalid && this.dataService.updateGiftForm.controls.price.errors.pattern"
              class="errorText row justify-content-center">
              Hinta-arvio saa sisältää vain numeroita, syötäthän hinta-arvion kokonaislukuna.
            &lt/p>
            &ltp *ngIf=" this.dataService.updateGiftForm.controls.price.invalid && this.dataService.updateGiftForm.controls.price.errors.maxlength"
              class="errorText row justify-content-center">
              Lahjan hinta saa olla maksimissaan 15 merkkiä pitkä.
            &lt/p>


            &ltlabel for="link">Lahjan verkko-osoite&lt/label>
            &ltinput formControlName="link" type="text" class="form-control" placeholder="Syötä lahjan verkko-osoite">

            &ltlabel for="description">Lahjan kuvaus&lt/label>
            &lttextarea formControlName="description" type="text" rows="5" class="form-control" placeholder="Syötä lahjan kuvaus">&lt/textarea>
            &ltp *ngIf=" this.dataService.updateGiftForm.controls.description.invalid && this.dataService.updateGiftForm.controls.description.errors.maxlength"
              class="errorText row justify-content-center">
              Lahjan kuvaus saa olla maksimissaan 160 merkkiä pitkä.
            &lt/p>

          &ltbutton *ngIf="adminStatus"class="btn btn-blu" style="float: right;" (click)="updateGift(gift)" [disabled] = "!this.dataService.updateGiftForm.valid" >Tallenna&lt/button>
          &ltbutton *ngIf="adminStatus"class="btn btn-red" style="float: right;" (click)="cancelEdit(gift)">Peruuta&lt/button>
          &lt/form>
        &lt/div>

        <&lt/div>

      </div>
	  
	  
    </code> </pre>
	
	 <div class="carousel-item">
	<p>Metodi, jolla muokataan näkymän tilaa.</p>
	<p>lahjalista.component.ts:</p>
	<pre class="d-block w-100" alt="Second slide"> <code class="language-javascript codebase">
	
	  editStatusChanger(gift) {
    if (!this.editStatus) {

      // kun lahjan muokkausta on klikattu, asetetaan lahjan arvot placeholdereiksi.
      this.dataService.updateGiftForm.controls.name.setValue(gift.name);
      this.dataService.updateGiftForm.controls.price.setValue(gift.price);
      this.dataService.updateGiftForm.controls.description.setValue(gift.description);
      this.dataService.updateGiftForm.controls.price.setValue(gift.price);

      // aseteteaan ediStatus trueksi sekä napataan lahja documentID talteen.
      this.editStatus = true, this.SelectedGiftID = gift.documentID;
      // muuten laitetaan editStatus falseksi.
    } else { this.editStatus = false; }

  }
	
	
	
	
	</code> </pre>
    </div>
	
	 <div class="carousel-item">
	<p>Metodi, jolla haetaan tarkastetaan onko kirjautunut käyttäjä ylläpitäjä.</p>
	<p>data.service.ts:</p>
	<pre class="d-block w-100" alt="Second slide"> <code class="language-javascript codebase">
	
	   /*
  getAdminStatus() on metodi, jolla tarkistetaan onko kirjautunut käyttäjä valitun ryhmän ylläpitäjä.
  Palauttaa true/false. Tämän avulla saadaan ylläpitäjälle erilaisia oikeuksia, kuten ryhmän muokkaus yms.
  */
  getAdminStatus() {

    return new Promise<any>((resolve, reject) => {

      this.getCurrentGroupFromLocalStorage().then(res => {

        return new Promise<any>((resolve, reject) => {
          // haetaan ryhmä, localstoragessa olevan ryhmäkoodin perusteella.
          let group = this.firestore.collection('groups', ref => ref.where('groupCode', '==', res.groupCode)).snapshotChanges();
          console.log(group);
          group.pipe(take(1)).subscribe(data => {
            resolve(data[0].payload.doc.data());

          });
        }).then(groupData => {
          //  haetaan käyttäjä.
          this.getCurrentUserFromDatabase().then(
            (data) => { this.currentUser = data, console.log(data); },
            (err) => console.error(err)
          ).then(() => {
            // verrataan täsmääkö kirjautuneen käyttäjän userID ryhmän adminin ID:tä.
            // jos täsmää niin palautetaan true, jos ei niin palautetaan false.
            if (this.currentUser.userID === groupData.groupAdmin) {
              resolve(true); console.log('admin status: ' + true);
            } else { resolve(false); }

          });
        }

        );
      });
    });
  }
	
	
	
	
	</code> </pre>
    </div>
	
	
	
	
	
    </div>
   
	
	 
	
  </div>
  
</div>
       
      </div>
    </div>
  </div>
  

  


								
									
									
</section>

									<section>
							
									
									
									<h3> Tietokannan rakenne: </h3>

								<p>Ryhmillä on käyttäjiä sekä käyttäjillä ryhmiä, firebase tietokannalla ei ollut kuitenkaan mahdollista "linkata" näitä toisiinsa. Lähetettävä data määriteltiin lomakkeiden avulla. </p>
										<div class="buttons d-flex justify-content-between">
										  <button href="#tietokantarakenne"  class="btn btn-outline-dark btn-lg" data-slide="prev">
												<p class="buttontext">takaisin</p>
										</button>
										
								   
										  <button href="#tietokantarakenne"  class="btn btn-outline-dark btn-lg" data-slide="next">
												<p class="buttontext">seuraava</p>
											</button>
								  
									  
									  </div>

									  
									  <div id="tietokantarakenne" class="carousel slide" data-ride="carousel" data-interval="false" style="margin-bottom: 1%;">
									  
								  <div class="carousel-inner">
									<div class="carousel-item active">
										<p>Yleiskatsaus.</p>
									  <img class="d-block w-100" src="images/tietokantarakenne.jpg" alt="First slide">
									</div>
									<div class="carousel-item">
									<p>Käyttäjä:</p>
									 <img class="d-block w-100" src="images/käyttäjätietokanta.jpg" alt="Second slide">
									</div>
									<div class="carousel-item">
									<p>Ryhmä:</p>
									 <img class="d-block w-100" src="images/ryhmätietokanta.jpg" alt="Third slide">
									</div>
									
									<div class="carousel-item">
									<p>Ryhmän luontiin käytettävä lomake:</p>
									<p>data.service.ts:</p>
									<pre class="d-block w-100" alt="Fourth slide"> <code class="language-javascript codebase">
  // groupForm on lomake, joka määrittelee ryhmän datan.
  groupForm = new FormGroup({
    groupAdmin: new FormControl(''),
    description: new FormControl(''),
    event: new FormControl('', [Validators.required, Validators.minLength(3)]),
    groupName: new FormControl('', [Validators.required, Validators.maxLength(30)]),
    groupCode: new FormControl('Koodi'),
    lahjalista: new FormControl({ lahja: { nimi: '', hinta: '' } }),
    joinedUsers: new FormControl([]),
    date: new FormControl(''),
  });
									
									
									</code> </pre>
									</div>
									
											<div class="carousel-item">
									<p>Käyttäjän luontiin käytettävä lomake:</p>
									<p>auth.service.ts:</p>
									<pre class="d-block w-100" alt="Fourth slide"> <code class="language-javascript codebase">
   // lomake, jota käytetään rekisteröintiin.
  registerForm = new FormGroup({

    email: new FormControl('', [Validators.pattern('^[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+[.][a-zA-Z0-9-.]+$'), Validators.required]),
    password: new FormControl('', [Validators.required, Validators.minLength(6)]),
    name: new FormControl('', [Validators.required ,Validators.minLength(4),
      Validators.maxLength(15), Validators.pattern('^[a-zA-Z0-9]+$')]),
    confirmPassword: new FormControl('', [Validators.required]),

  }, {validators: this.passwordConfirming});
  
   // metodi, jolla katsotaan täsmääkö salasanat. käytetään rekisteröintilomakkeen validaatiossa.
   passwordConfirming(c: AbstractControl): { invalid: boolean } {
    if (c.get('password').value !== c.get('confirmPassword').value) {
        return {invalid: true};
    }
}

									
									
									</code> </pre>
									</div>
								  
								</div>

								</div>
									
									
								</section>
				
				
													<section>
							
									
									
									<h3> Testaus: </h3>

								<p>Tein projektissa myös käyttöliittymä testausta (manuaalisesti), ajan puutteen vuoksi testaaminen jäi itsellä kuitenkin vähäiseksi. Testailimme ominaisuuksia hyväksymiskriteereiden perusteella. 
									Jokaiselle sprinttiin otetulle käyttäjäkertomukselle luotiin testisuunnitelma. Esimerkki ala-puolella.</p>
								
									<img src="images/testiraportti.jpg" alt="Lahja-Jaakko" style="width: 100%;">
									
								</section>
				
				
				
				

								<section>
							
									
									<h2>Reflektio</h2>
									<p>Tämä oli ensimmäinen isompi web-applikaatio, jonka parissa olen työskennellyt. Joten oppiminen oli todella laaja-alaista. 
										Toiminnallisuuksien koodaminen parani joka viikko, ja ensimmäisten viikkojen räpellykset alkoivat näyttämään kamalalta. 
										Olen kuitenkin ylpeä itsestäni, että saatiin melko toimiva sovellus tehtyä, vaikka aiempaa kokemusta ei juurikaan ollut.  </p>
									<h3>Tärkeimmät asiat mitä opin?</h3>
									<p class="reflektiotext">Asynkroninen ohjelmointi. Opin ketjuttamaan asynkronisia operaatioita (callbackit, promiset, observablet, subscribet). 
										Teoria-puolta en vielä ymmärrä täysin, mutta käytännön osaaminen on jo melko hyvää.
									</p>
									<p class="reflektiotext">
										Lomakkeiden tekeminen, niiden validaatiot sekä käyttö yhdessä HTML kanssa.
									</p>
									<p class="reflektiotext">
										Firebase tietokannan toiminta sekä CRUD-metodit.
									</p>
									<p class="reflektiotext">
										SCRUM:in toiminta käytännössä.
									</p>
										<p class="reflektiotext">
										GIT: merget ja commitit.
									</p>
									<h3>Mitä olisit tehnyt toisin?</h3>
									<p class="reflektiotext">Olisin käyttänyt projektin alussa enemmän aikaa suunnitteluun.</p>
									<p class="reflektiotext">Tietokanta/backEnd ratkaisua suunnitellessa olisin huomioinut paremmin sovelluksen kasvun.</p>
									<h3>Mitä osaamista haluaisit kehittää jatkossa?</h3>
									<p class="reflektiotext">Backend osaamista.</p>
									<p class="reflektiotext">Teorian opiskelu, ainakin angularin osalta.</p>
									<p class="reflektiotext">Automaatiotestaus.</p>
									<p class="reflektiotext">Gitin oikeaoppinen käyttö.</p>
									
								</section>
								
				</div>			
							
					</div>
					</div>
					

				<!-- Footer -->
					<div id="footer">
						<ul class="copyright">
							<li>&copy; Oskari Mannila | 2020</li><li>Original design: <a href="http://html5up.net">HTML5 UP</a></li>
						</ul>
					</div>

			</div>

		<!-- Scripts -->
			<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
			<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
			<script src="assets/js/jquery.min.js"></script>
			<script src="assets/js/browser.min.js"></script>
			<script src="assets/js/breakpoints.min.js"></script>
			<script src="assets/js/util.js"></script>
			<script src="assets/js/main.js"></script>
			<script src="assets/js/prism.js"></script>

	</body>
</html>